<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Offline Maps Service Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .result {
            margin: 10px 0;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
            border-left: 4px solid #007bff;
        }
        .error {
            border-left-color: #dc3545;
            background: #f8d7da;
        }
        .success {
            border-left-color: #28a745;
            background: #d4edda;
        }
        input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin: 5px;
        }
        .progress {
            width: 100%;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
        }
        .progress-bar {
            height: 100%;
            background: #007bff;
            transition: width 0.3s;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üó∫Ô∏è Offline Maps Service Test</h1>
        
        <section>
            <h2>Location Detection</h2>
            <button onclick="detectLocation()">Detect My Location</button>
            <div id="locationResult"></div>
        </section>

        <section>
            <h2>City Search</h2>
            <input type="text" id="citySearch" placeholder="Search for a city..." />
            <button onclick="searchCities()">Search Cities</button>
            <div id="searchResults"></div>
        </section>

        <section>
            <h2>Popular Cities</h2>
            <button onclick="getPopularCities()">Load Popular Cities</button>
            <div id="popularCities"></div>
        </section>

        <section>
            <h2>Download Maps</h2>
            <div>
                <select id="citySelect">
                    <option value="">Select a city to download</option>
                </select>
                <button onclick="downloadMaps()" id="downloadBtn">Download Maps</button>
                <button onclick="cancelDownload()" id="cancelBtn" disabled>Cancel Download</button>
            </div>
            <div id="downloadProgress"></div>
        </section>

        <section>
            <h2>Offline Maps</h2>
            <button onclick="getOfflineMaps()">List Downloaded Maps</button>
            <div id="offlineMaps"></div>
        </section>
    </div>

    <script type="module">
        // Mock implementation for testing (replace with actual service import)
        window.testOfflineMaps = {
            async detectUserCity() {
                // Simulate geolocation
                return new Promise((resolve) => {
                    if (navigator.geolocation) {
                        navigator.geolocation.getCurrentPosition(
                            position => {
                                const { latitude: lat, longitude: lng } = position.coords;
                                // Mock city info
                                resolve({
                                    id: `test-city-${Date.now()}`,
                                    name: `City at ${lat.toFixed(4)}, ${lng.toFixed(4)}`,
                                    country: 'Test Country',
                                    bounds: {
                                        north: lat + 0.05,
                                        south: lat - 0.05,
                                        east: lng + 0.05,
                                        west: lng - 0.05
                                    },
                                    center: { lat, lng }
                                });
                            },
                            error => {
                                console.error('Geolocation error:', error);
                                resolve(null);
                            }
                        );
                    } else {
                        resolve(null);
                    }
                });
            },

            async searchCities(query) {
                // Mock search results
                return [
                    { id: 'mock-1', name: `${query} City 1`, country: 'Test Country' },
                    { id: 'mock-2', name: `${query} City 2`, country: 'Test Country' }
                ];
            },

            async getPopularCities() {
                return [
                    { id: 'nyc', name: 'New York City', country: 'United States' },
                    { id: 'london', name: 'London', country: 'United Kingdom' },
                    { id: 'paris', name: 'Paris', country: 'France' },
                    { id: 'tokyo', name: 'Tokyo', country: 'Japan' }
                ];
            },

            async downloadCityMaps(cityId, options = {}) {
                const onProgress = options.onProgress;
                let progress = 0;
                
                const interval = setInterval(() => {
                    progress += Math.random() * 20;
                    if (progress >= 100) {
                        progress = 100;
                        clearInterval(interval);
                    }
                    
                    if (onProgress) {
                        onProgress({
                            cityId,
                            cityName: `City ${cityId}`,
                            totalTiles: 1000,
                            downloadedTiles: Math.floor(progress * 10),
                            failedTiles: 0,
                            progress,
                            status: progress >= 100 ? 'completed' : 'downloading',
                            estimatedSize: 50000000,
                            downloadedSize: Math.floor(progress * 500000),
                            startTime: Date.now()
                        });
                    }
                }, 500);
            },

            async getOfflineMaps() {
                return [
                    {
                        id: 'offline-1',
                        cityId: 'nyc',
                        cityName: 'New York City',
                        downloadDate: new Date().toISOString(),
                        tileCount: 1000,
                        sizeBytes: 50000000
                    }
                ];
            }
        };

        // Test functions
        window.detectLocation = async function() {
            const result = document.getElementById('locationResult');
            result.innerHTML = '<div class="result">Detecting location...</div>';
            
            try {
                const city = await window.testOfflineMaps.detectUserCity();
                if (city) {
                    result.innerHTML = `
                        <div class="result success">
                            <strong>Location Detected!</strong><br>
                            City: ${city.name}<br>
                            Country: ${city.country}<br>
                            Coordinates: ${city.center.lat.toFixed(4)}, ${city.center.lng.toFixed(4)}
                        </div>
                    `;
                    
                    // Add to city select
                    const select = document.getElementById('citySelect');
                    const option = document.createElement('option');
                    option.value = city.id;
                    option.textContent = `${city.name}, ${city.country}`;
                    select.appendChild(option);
                } else {
                    result.innerHTML = '<div class="result error">Could not detect location</div>';
                }
            } catch (error) {
                result.innerHTML = `<div class="result error">Error: ${error.message}</div>`;
            }
        };

        window.searchCities = async function() {
            const query = document.getElementById('citySearch').value;
            const results = document.getElementById('searchResults');
            
            if (!query.trim()) {
                results.innerHTML = '<div class="result error">Please enter a city name</div>';
                return;
            }
            
            results.innerHTML = '<div class="result">Searching...</div>';
            
            try {
                const cities = await window.testOfflineMaps.searchCities(query);
                if (cities.length > 0) {
                    const select = document.getElementById('citySelect');
                    results.innerHTML = `
                        <div class="result success">
                            <strong>Found ${cities.length} cities:</strong><br>
                            ${cities.map(city => `‚Ä¢ ${city.name}, ${city.country}`).join('<br>')}
                        </div>
                    `;
                    
                    // Add to city select
                    cities.forEach(city => {
                        const option = document.createElement('option');
                        option.value = city.id;
                        option.textContent = `${city.name}, ${city.country}`;
                        select.appendChild(option);
                    });
                } else {
                    results.innerHTML = '<div class="result">No cities found</div>';
                }
            } catch (error) {
                results.innerHTML = `<div class="result error">Error: ${error.message}</div>`;
            }
        };

        window.getPopularCities = async function() {
            const results = document.getElementById('popularCities');
            results.innerHTML = '<div class="result">Loading...</div>';
            
            try {
                const cities = await window.testOfflineMaps.getPopularCities();
                const select = document.getElementById('citySelect');
                
                results.innerHTML = `
                    <div class="result success">
                        <strong>Popular Cities:</strong><br>
                        ${cities.map(city => `‚Ä¢ ${city.name}, ${city.country}`).join('<br>')}
                    </div>
                `;
                
                // Clear and populate city select
                select.innerHTML = '<option value="">Select a city to download</option>';
                cities.forEach(city => {
                    const option = document.createElement('option');
                    option.value = city.id;
                    option.textContent = `${city.name}, ${city.country}`;
                    select.appendChild(option);
                });
            } catch (error) {
                results.innerHTML = `<div class="result error">Error: ${error.message}</div>`;
            }
        };

        window.downloadMaps = async function() {
            const cityId = document.getElementById('citySelect').value;
            if (!cityId) {
                alert('Please select a city first');
                return;
            }
            
            const progressDiv = document.getElementById('downloadProgress');
            const downloadBtn = document.getElementById('downloadBtn');
            const cancelBtn = document.getElementById('cancelBtn');
            
            downloadBtn.disabled = true;
            cancelBtn.disabled = false;
            
            progressDiv.innerHTML = `
                <div class="result">
                    <strong>Downloading maps for city...</strong>
                    <div class="progress">
                        <div class="progress-bar" id="progressBar" style="width: 0%"></div>
                    </div>
                    <div id="progressText">Preparing download...</div>
                </div>
            `;
            
            try {
                await window.testOfflineMaps.downloadCityMaps(cityId, {
                    onProgress: (progress) => {
                        const bar = document.getElementById('progressBar');
                        const text = document.getElementById('progressText');
                        
                        if (bar) bar.style.width = `${progress.progress}%`;
                        if (text) {
                            text.innerHTML = `
                                ${progress.status}: ${progress.progress.toFixed(1)}%<br>
                                Downloaded: ${progress.downloadedTiles}/${progress.totalTiles} tiles<br>
                                Size: ${(progress.downloadedSize / 1024 / 1024).toFixed(1)} MB
                            `;
                        }
                        
                        if (progress.status === 'completed') {
                            progressDiv.innerHTML = `
                                <div class="result success">
                                    <strong>Download Completed!</strong><br>
                                    City: ${progress.cityName}<br>
                                    Tiles: ${progress.downloadedTiles}<br>
                                    Size: ${(progress.downloadedSize / 1024 / 1024).toFixed(1)} MB
                                </div>
                            `;
                            downloadBtn.disabled = false;
                            cancelBtn.disabled = true;
                        }
                    }
                });
            } catch (error) {
                progressDiv.innerHTML = `<div class="result error">Download failed: ${error.message}</div>`;
                downloadBtn.disabled = false;
                cancelBtn.disabled = true;
            }
        };

        window.cancelDownload = function() {
            const progressDiv = document.getElementById('downloadProgress');
            const downloadBtn = document.getElementById('downloadBtn');
            const cancelBtn = document.getElementById('cancelBtn');
            
            progressDiv.innerHTML = '<div class="result">Download cancelled</div>';
            downloadBtn.disabled = false;
            cancelBtn.disabled = true;
        };

        window.getOfflineMaps = async function() {
            const results = document.getElementById('offlineMaps');
            results.innerHTML = '<div class="result">Loading...</div>';
            
            try {
                const maps = await window.testOfflineMaps.getOfflineMaps();
                if (maps.length > 0) {
                    results.innerHTML = `
                        <div class="result success">
                            <strong>Downloaded Maps (${maps.length}):</strong><br>
                            ${maps.map(map => `
                                ‚Ä¢ ${map.cityName}<br>
                                &nbsp;&nbsp;Tiles: ${map.tileCount}<br>
                                &nbsp;&nbsp;Size: ${(map.sizeBytes / 1024 / 1024).toFixed(1)} MB<br>
                                &nbsp;&nbsp;Downloaded: ${new Date(map.downloadDate).toLocaleDateString()}
                            `).join('<br><br>')}
                        </div>
                    `;
                } else {
                    results.innerHTML = '<div class="result">No offline maps downloaded yet</div>';
                }
            } catch (error) {
                results.innerHTML = `<div class="result error">Error: ${error.message}</div>`;
            }
        };

        // Auto-load popular cities on page load
        window.addEventListener('load', () => {
            getPopularCities();
        });
    </script>
</body>
</html>